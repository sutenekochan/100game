<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<!--script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script-->
<script type="text/javascript" src="jquery-2.1.4.min.js"></script>


<!-- デバッグ用 -->
<style type="text/css">
  .controller {   display:none /**/ }  /* コメント化するとデバッグ用情報を表示 */
</style>
<script type="text/javascript">
  var startX = 1;  // この座標のマスから始める
  var startY = 1;
</script>


<!-- ここからメイン -->
<style type="text/css">
  .sheet { background: #eee }                /* 表全体 */
  .currentColumn { background: #ffa }        /* フォーカスのあるマス */
  .currentColumnHeader {                     /* フォーカスのある行・列 */
     background: #cff;
     color: #f00
  }
  .correctColumn { background: #ddd }        /* 正解マス */
  .wrongColumn {                             /* 間違ったマス */
    background: #fdd;
    background-image: url("wrongAnswer.png")
  }
  .sheetComplete {                           /* 全問正解のはなまる。最初は隠れている */
    display: none
  }
</style>

<script type="text/javascript">

// --------------------------------------------------
// グローバル変数
var startTime = 0;

// --------------------------------------------------
// 効果音
// 先読みのため初回にグローバル変数を作っておく
// ブラウザによっては、初回再生前に頭出し処理ができないため、再生したかどうかのフラグを置く
var soundCorrect = new Audio("Quiz-Correct_Answer02-1.mp3");  // 正解
var soundCorrectPlayed = 0;
var soundWrong = new Audio("Quiz-Wrong_Buzzer02-1.mp3");      // 不正解
var soundWrongPlayed = 0;
var soundClear = new Audio("Quiz-Results02-1.mp3");           // 合格
var soundClearPlayed = 0;
var soundGameOver = new Audio("Phrase04-1.mp3");              // 不合格
var soundGameOverPlayed = 0;


// --------------------------------------------------
function makeColumnName(x, y, flag)
  // #s12 とかの名前を作る
  // 3つめの引数を指定すると # をつけなくなる (s12とかなる)
{
  var xx = x;  if(xx == 10) { xx = "a"; }
  var yy = y;  if(yy == 10) { yy = "a"; }
  var columnName  = "s" +  xx  + yy;
  if(typeof flag === "undefined")
  {
    columnName = "#" + columnName;
  }
  return columnName;
}


// --------------------------------------------------
function focusColumnSub (x, y, a)
  // 内部関数。座標(x,y)の色を付けたり消したり。CSSクラスの追加削除を行う
  // x,y：座標。1～10の数字であること (引数チェックはしていない)
  // a: 1なら追加、2なら削除
{
  var columnName  = makeColumnName(x, y);
  var columnNameX = makeColumnName(x, 0);
  var columnNameY = makeColumnName(0, y);

  if(a == 1)
  {
    $(function(){
      $(columnName).addClass("currentColumn")
      $(columnNameX).addClass("currentColumnHeader")
      $(columnNameY).addClass("currentColumnHeader")
    });
  } else {
    $(function(){
      $(columnName).removeClass("currentColumn")
      $(columnNameX).removeClass("currentColumnHeader")
      $(columnNameY).removeClass("currentColumnHeader")
    });
  }
};


// --------------------------------------------------
  // 座標(x,y)の色を付ける/消す。x,y は1～10の数字
function focusColumn (x, y) { focusColumnSub (x, y, 1) };
function unfocusColumn (x, y) { focusColumnSub (x, y, 2) };


// --------------------------------------------------
function randN(min, max, prev)
  // 最小値～最大値の範囲で乱数を返す
  // 前回の値を指定することで、前回の値と違う値を返す (同じ数字が連続しない機能)
  // 引数：乱数の最小値、最大値、前回の値
{
  for(;;)
  {
    var x = Math.floor(Math.random() * (max-min+1)) + min;
    if(x != prev)
    {
      return x;
    }
  }
}


// --------------------------------------------------
function remake()
  // 表の再作成。ページロード・ボタン押下で呼ばれる
{
  var calcType = $("#calcType").val();

  var minX=1, maxX=9, minY=1, maxY=9, typestr="", divflag=0;  // 念のためのデフォルト値をセット

  if     (calcType == "add_1_1")   { minX=1;   maxX=9;   minY=1;   maxY=9;   typestr="足しざん";  }
  else if(calcType == "add_2_1")   { minX=10;  maxX=99;  minY=1;   maxY=9;   typestr="足しざん";  }
  else if(calcType == "add_1_2")   { minX=1;   maxX=9;   minY=10;  maxY=99;  typestr="足しざん";  }
  else if(calcType == "add_2s_2s") { minX=10;  maxX=19;  minY=10;  maxY=19;  typestr="足しざん";  }
  else if(calcType == "add_2_2")   { minX=10;  maxX=99;  minY=10;  maxY=99;  typestr="足しざん";  }
  else if(calcType == "sub_2_1")   { minX=10;  maxX=19;  minY=1;   maxY=9;   typestr="引きざん";  }
  else if(calcType == "mul_1_1")   { minX=1;   maxX=9;   minY=1;   maxY=9;   typestr="かけざん";  }
  else if(calcType == "div_2_1")   { minX=10;  maxX=99;  minY=2;   maxY=9;   typestr="わりざん";  divflag=1;  }
  else                             { alert("プログラムのどこかにミスがある模様(r)");  return;  }

  $("#calcTypeStr").val(typestr);



  // table タグを生成。割り算時にはテーブル構成が変わるので表自体を動的生成する
  var sheetstr = "";
  sheetstr += '<table border="1px" class="sheet" style="position: relative; top: 0px;">' + "\n";


  // 1列目 (数値が書かれている列)
  sheetstr += '<tr height=50px><th width=50px id="s00">';
  var x1=0, x2;
  for(var cols=0; cols<10; cols++) {
    var columnName = makeColumnName(cols+1, 0, 1);
    x2 = randN(minX, maxX, x1);
    sheetstr += '<th width=50px id="' + columnName + '">' + x2;
    x1 = x2;
  }
  sheetstr += "\n";

  // 2列目以降 (除算以外)
  if(divflag == 0)
  {
    var y1 = 0;
    var y2;

    for(var rows=0; rows<10; rows++)
    {
      var columnName = makeColumnName(0, rows+1, 1);
      y2 = randN(minY,maxY,y1);
      sheetstr += '<tr height=50px>';
      sheetstr += '<th id="' + columnName + '">' + y2;
      y1 = y2;
      for(var cols=0; cols<10; cols++) {
        columnName = makeColumnName(cols+1, rows+1, 1);
        sheetstr += '<td id="' + columnName + '">';
      }
      sheetstr += "\n";
    }
  }


  // 縦の列2列目以降 (除算)
  else    // divflag == 0
  {
    var y1 = 0;
    var y2;

    for(var rows=0; rows<5; rows++)
    {
      var columnName = makeColumnName(0, rows*2+1, 1);
      y2 = randN(minY,maxY,y1);
      sheetstr += '<tr height=40px>';
      sheetstr += '<th rowspan=3 id="' + columnName + '">' + y2;
      y1 = y2;
      for(var cols=0; cols<10; cols++) {
        columnName = makeColumnName(cols+1, rows*2+1, 1);
        sheetstr += '<td style="border-bottom: 0px" id="' + columnName + '">';
      }
      sheetstr += '<tr height=20px>';
      for(var cols=0; cols<10; cols++) {
        sheetstr += '<td style="border-top: 0px; border-bottom: 0px"><font size="-3">　あまり</font>';
      }
      sheetstr += '<tr height=40px>';
      for(var cols=0; cols<10; cols++) {
        columnName = makeColumnName(cols+1, rows*2+2, 1);
        sheetstr += '<td style="border-top: 0px" id="' + columnName + '">';
      }
    }
  }


  sheetstr += '<table>';

  // HTMLに書き込み
  document.getElementById("sheet").innerHTML = sheetstr;

  // tableタグの作成ここまで


  // すべての表示色・表示内容をリセット
  for(var x = 1; x<=10; x++)
  {
    for(var y = 1; y<=10; y++)
    {
      var columnName = makeColumnName(x, y);

      $(columnName).text("");
      $(columnName).removeClass("correctColumn");
      $(columnName).removeClass("wrongColumn");
    }
  }

  // 各種値をリセット
  $("#score").val(0);
  startTime = 0;
  $("#sheetComplete").hide();
}


// --------------------------------------------------
function calcKeta(n)
  // nの桁数を求める。nは正の値であること
{
  var i = 1;
  var ii = 1;

  // 0の場合だけ特別扱い
  if(n==0)
  {
    return 1;
  }

  for(;;)
  {
    if(ii <= n && n < ii*10) { return i; }
    i++;
    ii *= 10;
  }
}



// --------------------------------------------------
function gotoXY(x,y)
  // (x,y) の座標に進む
  // 昔の場所の色を消し、新しい場所に色を付ける
  // 正答を計算する
{
  var calcType = $("#calcTypeStr").val();

  var oldX = $("#currentColumnX").val();
  var oldY = $("#currentColumnY").val();
  unfocusColumn(oldX, oldY);

  $("#currentColumnX").val(x);
  $("#currentColumnY").val(y);

  focusColumn(x,y);

  var columnNameX = makeColumnName(x, 0);
  var valueX = $(columnNameX).text();

  // 除算の剰余を求める場合、Yの位置がずれる
  var yy = y;
  if(calcType == "わりざん" && y%2 == 0) { yy--; }
  var columnNameY = makeColumnName(0, yy);
  var valueY = $(columnNameY).text();

  var answer;
  if     (calcType == "足しざん") { answer = parseInt(valueX) + parseInt(valueY); }
  else if(calcType == "引きざん") { answer = valueX - valueY; }
  else if(calcType == "かけざん") { answer = valueX * valueY; }
  else if(calcType == "わりざん" && y%2 == 1) { answer = Math.floor(valueX / valueY); }
  else if(calcType == "わりざん") { answer = valueX % valueY; }
  else                            { alert("プログラムのどこかにミスがある模様(g)"); return; }
  $("#correctAnswer").val(answer);

  var keta = calcKeta(answer);
  $("#correctAnswerKeta").val(keta);

  $("#inputAnswer").val("");
}


// --------------------------------------------------
$(window).keydown(function(e)
  // キー入力をトラップ。数字キーを処理する
{
  var k = e.keyCode;
  var n = -1;
  if     (k==96  || k==48) {  n=0;   }  // テンキー「0」と通常キー「0」。以下同じ
  else if(k==97  || k==49) {  n=1;   }
  else if(k==98  || k==50) {  n=2;   }
  else if(k==99  || k==51) {  n=3;   }
  else if(k==100 || k==52) {  n=4;   }
  else if(k==101 || k==53) {  n=5;   }
  else if(k==102 || k==54) {  n=6;   }
  else if(k==103 || k==55) {  n=7;   }
  else if(k==104 || k==56) {  n=8;   }
  else if(k==105 || k==57) {  n=9;   }
  else if(k==8   || k==46) {  n=10;  }  // 「BS」「DEL」


  if(window.navigator.userAgent.indexOf("Android") != -1)  // Android Chrome対応
  {
    $("#keyboardEnabler").blur();
    $("#keyboardEnabler").focus();
  }

  if(n != -1)
  {
    e.preventDefault();

    inputandCheckAnswer(n);
  }

 return true;
});


// --------------------------------------------------
function playSound(n)
  // n番目の音を再生。現状 n は1(Correct) 2(Wrong) 3(soundClear) 4(soundGameOver) の決め打ち
{
  var soundEnabled = $("#soundEnabled").prop("checked");
  if(! soundEnabled)
  {
    return;
  }

  if(n == 1)
  {
    if(soundCorrectPlayed == 0)
    {
      soundCorrectPlayed = 1;
    }
    else
    {
      soundCorrect.currentTime = 0;
    }
    soundCorrect.play();
  }

  else if(n == 2)
  {
    if(soundWrongPlayed == 0)
    {
      soundWrongPlayed = 1;
    }
    else
    {
      soundWrong.currentTime = 0;
    }
    soundWrong.play();
  }

  else if(n == 3)
  {
    if(soundClearPlayed == 0)
    {
      soundClearPlayed = 1;
    }
    else
    {
      soundClear.currentTime = 0;
    }
    soundClear.play();
  }

  else if(n == 4)
  {
    if(soundGameOverPlayed == 0)
    {
      soundGameOverPlayed = 1;
    }
    else
    {
      soundGameOver.currentTime = 0;
    }
    soundGameOver.play();
  }


}

// --------------------------------------------------
function inputandCheckAnswer(n)
  // 値を入力、入力された値を確認
  // n：0～9＝数字、10＝BS
{
  // 開始時間をセット
  if(startTime == 0)
  {
    startTime = new Date();
  }

  var correctAnswer = $("#correctAnswer").val();
  var correctAnswerKeta = $("#correctAnswerKeta").val();

  var inputAnswer = $("#inputAnswer").val();  // columnName を直接扱うと、空白文字のせいで誤動作する

  if(inputAnswer == "" && n == 0 && correctAnswer != 0)  // 最初の文字が0、かつ、正解が0でない
  {
    return;
  }

  if(inputAnswer == "" && n == 10)  // BS・DELで既入力なし
  {
    return;
  }

  if(0 <= n && n <= 9)
  {
    inputAnswer += n;
  }
  else if(n == 10)  // BS・DEL
  {
    inputAnswer = Math.floor(inputAnswer / 10);
    if(inputAnswer == 0) { inputAnswer = ""; }
  }
  else
  {
    alert("プログラムのどこかにミスがある模様(i)");
    return;
  }

  $("#inputAnswer").val(inputAnswer);
  
  var x = $("#currentColumnX").val();
  var y = $("#currentColumnY").val();
  var columnName = makeColumnName(x, y);
  $(columnName).text(inputAnswer);

  // BS・DELの結果、inputAnswer が "" になってしまった場合に、帰る
  if(inputAnswer == "")
  {
    return;
  }

  var inputAnswerKeta = calcKeta(inputAnswer);

  if(correctAnswer == inputAnswer)  // 正解
  {
    $(columnName).addClass("correctColumn");
    var score = $("#score").val();
    score++;
    $("#score").val(score);
    playSound(1);
    gotoNext();
  }
  else if(correctAnswerKeta <= inputAnswerKeta)  // 入力桁数と正答桁数が同じ、かつ、不正解(不正解確定)
  {
    $(columnName).addClass("wrongColumn");
    playSound(2);
    gotoNext();
  }
  else  // 入力桁数が正答桁数に満たない
  {
    return;
  }

}


// --------------------------------------------------
function gotoNext()
  // 次のマスへ移動
{
  var x = $("#currentColumnX").val();
  var y = $("#currentColumnY").val();
  var calcType = $("#calcTypeStr").val();

  if(calcType != "わりざん")
  {
    // 除算以外：右のマスへ移動
    x++;
    if(x==11)
    {
      x=1;
      y++;
    }

    if(y==11)
    {
      finishAllColumn();
    }
    else
    {
      gotoXY(x,y);
    }
  }

  else
  {
    // 除算の場合
    if(y%2 == 1)  // 商入力中 → 剰余入力へ
    {
      y++;
      gotoXY(x,y);
    }
    else  // 剰余入力中 → 次のマスへ
    {
      x++;
      y--;
      if(x==11)
      {
        x=1;
        y+=2;
      }

      if(y==11)
      {
        finishAllColumn();
      }
      else
      {
        gotoXY(x,y);
      }
    }
  }

}


// --------------------------------------------------
function finishAllColumn()
{
  var score = $("#score").val();

  var endTime = new Date();
  var s = endTime - startTime;  // ミリ秒
  s = Math.floor((s + 999)/1000);
  m = Math.floor (s / 60);
  s -= (m * 60);

  var passScore = parseInt( $("#passScore").val() );

  if(score >= passScore)
  {
    $("#sheetComplete").show();
    playSound(3);
  }
  else
  {
    playSound(4);
  }


  alert("結果：" + score + "点。所要時間：" + m + "分" + s + "秒。おつかれさま！");
}


// --------------------------------------------------
function main()
{
  remake();
  gotoXY(startX, startY);
  //$("#startButton").blur();  // 「最初から」ボタンを押した後に、スペースキー等入力によるご動作を防ぐ
  $("#keyboardEnabler").focus();  // スマホ対応
}

// --------------------------------------------------
</script>


</head>

<body onload="main()">

<font size="+2" style="text-decoration:underline">みんなの100ます計算(ゲームバージョン)</font><br>
<br>
　　<select name="calcType" id="calcType">
<option value="add_1_1">足し算 (１けた)
<option value="add_2_1">足し算 (２けた＋１けた)
<option value="add_1_2">足し算 (１けた＋２けた)
<option value="add_2s_2s">足し算 (１９までの２けた)
<option value="add_2_2">足し算 (２けた)
<option value="sub_2_1">引き算 (２けた－１けた)
<option value="mul_1_1">かけ算 (１けた)
<option value="div_2_1">わり算 (２けた÷１けた)
</select>
　<button id="startButton" onclick="main()">はじめから</button>
　　スコア <input type="text" size=2 id="score">
 （ <select name="passScore" id="passScore">
<option value="100">100
<option value="98">98
<option value="95" selected>95
<option value="90">90
<option value="1">1
</select> 点でクリア）
　音<input type="checkbox" id="soundEnabled" checked="checked">
<br>
<br>

<div style="position: relative">
  <div id="sheet"></div><!-- 表はここに動的生成される。表全体の class が sheet。カラムの id が、s のあとに、縦、横の順の数字 (0～a)。s00～saaまで -->
  <img src="complete.png" class="sheetComplete" id="sheetComplete" style="position: absolute; top: 0px; "><!-- はなまる画像 -->
</div>

<br>
タブレットなら、ここをタップ。キーボードが出ます → <input type="number" id="keyboardEnabler" style="ime-mode: disabled; width: 50px" pattern="\d*">

<br>
<div  class="controller"><!-- ここはリリース時には表示されない部分 -->
 タイプ：<input type="text" size=4 id="calcTypeStr">
 X: <input type="text" size=1 id="currentColumnX">
 Y: <input type="text" size=1 id="currentColumnY">
 正答：<input type="text" size=2 id="correctAnswer">
 桁数：<input type="text" size=1 id="correctAnswerKeta">
 入力中の値：<input type="text" size=2 id="inputAnswer">
</div>

<br><br>
<hr>
(c) Nozomi<br>
v1.3  2015/09/26  除算対応<br>
<!--
v1.2.1  2015/07/30  合格・不合格での音追加<br>
v1.2  2015/07/25  合格点のときにはなまるを表示 (標準では95点で合格)・タブレットとりあえず対応 (スマホでも動くけど画面小さすぎ)<br>
v1.1  2015/07/23  効果音と「Ｘ」画像を追加<br>
v1.0  2015/07/22  1st ver.<br>
-->
<br>
効果音：<a href="http://musicisvfr.com/">Music VFR</a>さまで公開されている素材を利用(<a href="http://musicisvfr.com/free/se/quiz01.html">正解・不正解</a>／<a href="http://musicisvfr.com/free/se/phrase01.html">クリア</a>) (CC BY 4.0ライセンス)
</body>
</html>
